@using Sandler.Web.ViewModels;
@using Sandler.DB.Models;
@model EntityViewModel<TBL_CONTACTS>
<script src="~/Scripts/Application/ng-contacts.js" type="text/javascript"></script>
<script src="~/contents/knockout/knockout.mapping-latest.js" type="text/javascript"></script>

<div id="contact_body" style="background-color: white">

    @*Page Header*@
    <div class="row page-header">
        <div class="col-sm-8">
            <div class="row">
                <div class='page-title'><span>Contacts</span></div>
            </div>
            <div class="row sub-heading">
                <div class='page-subtitle' data-bind="text: pageTitle"></div>
            </div>
        </div>
        <div class="col-sm-4"></div>
    </div>

    <hr />


    @* Contact Details *@
    <div class="container">
        <div class="row">
            @* [[[[[ Contact Related ]]]]] *@
            <div class="col-md-6 no-margin">
                <div class="col-title"><span>Contact Information</span></div>

                <div class="row">
                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                <label>Company</label>
                                <div class="controls">
                                    <input id="contact_Company" type="text" data-bind="kendoDropDownList: { dataTextField: 'name', dataValueField: 'id', data: companies, value:contact.COMPANYID }" />
                                </div>

                                <label>Last Name&nbsp;<span class="label label-danger" data-bind='visible: contact.LASTNAME.hasError, text: contact.LASTNAME.validationMessage'></span>
                                </label>
                                <div class="controls">
                                    <input id="contact_LastName" class="form-control" maxlength="50" type="text" data-bind="value:contact.LASTNAME">
                                </div>
                                <label>First Name&nbsp;<span class="label label-danger" data-bind='visible: contact.FIRSTNAME.hasError, text: contact.FIRSTNAME.validationMessage'></span></label>
                                <div class="controls">
                                    <input id="contact_FirstName" class="form-control" maxlength="50" type="text" data-bind="value:contact.FIRSTNAME">
                                </div>
                                <label>Title</label>
                                <div class="controls">
                                    <input id="contact_Title" class="form-control" maxlength="50" type="text" data-bind="value:contact.Title">
                                </div>
                                <label>Contact's Department</label>
                                <div class="controls">
                                    <input id="contact_Department" class="form-control" maxlength="50" type="text" data-bind="value:contact.ContactsDepartment">
                                </div>
                                <label>Contact's Role</label>
                                <div class="controls">
                                    <input id="contact_Role" class="form-control" maxlength="50" type="text" data-bind="value:contact.ContactsRole">
                                </div>
                                <label>Phone</label>
                                <div class="controls">
                                    <input id="contact_Phone" class="form-control" maxlength="50" type="text" data-bind="value:contact.PHONE">
                                </div>
                                <label>Mobile Phone</label>
                                <div class="controls">
                                    <input id="contact_MobilePhone" class="form-control" maxlength="50" type="text" data-bind="value:contact.MobilePhone">
                                </div>
                                <label>Home Phone</label>
                                <div class="controls">
                                    <input id="contact_HomePhone" class="form-control" maxlength="50" type="text" data-bind="value:contact.HomePhone">
                                </div>
                                <label>Fax</label>
                                <div class="controls">
                                    <input id="contact_Fax" class="form-control" maxlength="50" type="text" data-bind="value:contact.Fax">
                                </div>
                                <label>Email</label>
                                <div class="controls">
                                    <input id="contact_Email" class="form-control" maxlength="50" type="text" data-bind="value:contact.EMAIL">
                                </div>
                                <label>Personal Email</label>
                                <div class="controls">
                                    <input id="contact_PersonalEmail" class="form-control" maxlength="50" type="text" data-bind="value:contact.PersonalEmail">
                                </div>

                            </div>
                        </form>
                    </div>
                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                <label>Contact's Address</label>
                                <div class="controls">
                                    <input id="contacts_Address" class="form-control" maxlength="50" type="text" data-bind="value:contact.Address">
                                </div>
                                <label>Contact's City</label>
                                <div class="controls">
                                    <input id="contacts_City" class="form-control" maxlength="50" type="text" data-bind="value:contact.City">
                                </div>
                                <label>Contact's State</label>
                                <div class="controls">
                                    <input id="contacts_State" class="form-control" maxlength="50" type="text" data-bind="value:contact.State">
                                </div>
                                <label>Contact's Zip</label>
                                <div class="controls">
                                    <input id="contacts_Zip" class="form-control" maxlength="50" type="text" data-bind="value:contact.Zip">
                                </div>
                                <label>Contact's Country</label>
                                <div class="controls">
                                    <input id="contacts_Country" class="form-control" maxlength="50" type="text" data-bind="value:contact.Country">
                                </div>
                            </div>
                        </form>
                    </div>


                </div>

            </div>

            <div class="col-md-6 no-margin">
                <div class="col-title"><span>Contact Details</span></div>

                <div class="row">

                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                <label>New Appointment?</label>
                                <div class="controls">
                                    <select data-bind="options: yesNoData, optionsText: 'Description', optionsValue: 'Value', value: contact.IsNewAppointment"></select>
                                </div>

                                <label>Appointment Source</label>
                                <div class="controls">
                                    <select data-bind="options: appointmentsource, optionsText: 'ApptSourceName', optionsValue: 'ApptSourceId', value: contact.ApptSourceId"></select>
                                </div>
                                <label>Registered for Trng?</label>
                                <div class="controls">
                                    <select data-bind="options: yesNoData, optionsText: 'Description', optionsValue: 'Value', value: contact.IsRegisteredForTraining"></select>
                                </div>
                                <label>Course Type</label>
                                <div class="controls">
                                    <select data-bind="options: courses, optionsText: 'CourseName', optionsValue: 'CourseId', value: contact.CourseId"></select>
                                </div>
                                <label>Course Training Date</label>
                                <div class="controls">
                                    <input id="contact_TrainingDate" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.CourseTrainingDate" />
                                </div>
                                <label>Training Course Name</label>
                                <div class="controls">
                                    <input id="contact_TrainingCourseName" maxlength="50" type="text" class="form-control" data-bind="value:contact.TrainingCourseName" />
                                </div>
                                <label>Home Many Attended?</label>
                                <div class="controls">
                                    <input id="contact_HowManyAttended" maxlength="50" type="text" class="form-control" data-bind="value:contact.HowManyAttended" />
                                </div>
                                <label>Company Name Where Training Conducted</label>
                                <div class="controls">
                                    <input id="contact_CompanyNameWhereTrainingConducted" maxlength="50" type="text" class="form-control" data-bind="value:contact.CompanyNameWhereTrainingConducted" />
                                </div>
                                <label>Discussion Topic</label>
                                <div class="controls">
                                    <input id="contact_DiscussionTopic" maxlength="50" type="text" class="form-control" data-bind="value:contact.DiscussionTopic" />
                                </div>
                                <label>Action Step</label>
                                <div class="controls">
                                    <input id="contact_ACTIONSTEP" maxlength="50" type="text" class="form-control" data-bind="value:contact.ACTIONSTEP" />
                                </div>
                                <label>Date Last Attempted</label>
                                <div class="controls">
                                    <input id="contact_LastAttemptedDate" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.LastAttemptedDate" />
                                </div>
                                <label>Last Contact Date</label>
                                <div class="controls">
                                    <input id="contact_lastContactDate" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.LAST_CONTACT_DATE" />
                                </div>
                                <label>Date Last Emailed</label>
                                <div class="controls">
                                    <input id="contact_DateLastEmailed" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.LastEmailedDate" />
                                </div>
                                <label>Date of Last Meeting</label>
                                <div class="controls">
                                    <input id="contact_LastMeetingDate" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.LastMeetingDate" />
                                </div>
                                <label>Date Letter Sent</label>
                                <div class="controls">
                                    <input id="contact_LetterSentDate" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.LetterSentDate" />
                                </div>
                                <label>Next Contact Date</label>
                                <div class="controls">
                                    <input id="contact_nextContactDate" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.NEXT_CONTACT_DATE" />
                                </div>

                            </div>
                        </form>
                    </div>

                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                <label>Email Subscription?</label>
                                <div class="controls">
                                    <select data-bind="options: yesNoData, optionsText: 'Description', optionsValue: 'Value', value: contact.IsEmailSubscription"></select>
                                </div>
                                <label>Need to Call Back?</label>
                                <div class="controls">
                                    <select data-bind="options: yesNoData, optionsText: 'Description', optionsValue: 'Value', value: contact.IsNeedCallBack"></select>
                                </div>
                                <label>BirthDay</label>
                                <div class="controls">
                                    <input id="contact_Birthday" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.Birthday" />
                                </div>
                                <label>Spouse's Name</label>
                                <div class="controls">
                                    <input id="contact_SpouseName" maxlength="50" type="text" class="form-control" data-bind="value:contact.SpouseName" />
                                </div>
                                <label>Anniversary</label>
                                <div class="controls">
                                    <input id="contact_Anniversary" style="max-width: 150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: contact.Anniversary" />
                                </div>
                                <label>Company Years</label>
                                <div class="controls">
                                    <input id="contact_CompanyYears" maxlength="50" type="text" class="form-control" data-bind="value:contact.CompanyYears" />
                                </div>
                                <label>Boss Name</label>
                                <div class="controls">
                                    <input id="contact_BossName" maxlength="50" type="text" class="form-control" data-bind="value:contact.BossName" />
                                </div>
                                <label>Referred By</label>
                                <div class="controls">
                                    <input id="contact_ReferredBy" maxlength="50" type="text" class="form-control" data-bind="value:contact.ReferredBy" />
                                </div>
                                <label>Contact's Notes</label>
                                <div class="controls">
                                    <input id="contact_Notes" maxlength="50" type="text" class="form-control" data-bind="value:contact.Notes" />
                                </div>

                            </div>
                        </form>
                    </div>

                </div>





            </div>

        </div>

        @* Page Footer *@
        <div class="row page-footer">
            <div class="pull-right">
                <button id="bt_cancel_evt" class="btn btn-danger btn-cancel" type="button">Cancel</button>
                <button id="bt_save_evt" class="btn btn-primary btn-save" type="button" data-bind="enable: isDirty, click: Save">Save</button>
            </div>
        </div>

    </div>

</div>

@*Custom extender for Last Name-required *@
<script>
    ko.extenders.required = function (target, overrideMessage) {
        //add some sub-observables to our observable
        target.hasError = ko.observable();
        target.validationMessage = ko.observable();

        //define a function to do validation
        function validate(newValue) {
            target.hasError(newValue ? false : true);
            target.validationMessage(newValue ? "" : overrideMessage || "*");
        }
        //initial validation
        validate(target());
        //validate whenever the value changes
        target.subscribe(validate);
        //return the original observable
        return target;
    };
</script>

<script type="text/javascript">

    @* Tracking whether there is unsaved change(s). *@
    ko.dirtyFlag_contact = function (root, isInitiallyDirty) {

        var result = function () { },
            _initialState = ko.observable(ko.toJSON(root)),
            _isInitiallyDirty = ko.observable(isInitiallyDirty);

        result.isDirty = ko.computed(function () {
            return _isInitiallyDirty() || _initialState() !== ko.toJSON(root);
        });

        result.reset = function () {
            _initialState(ko.toJSON(root));
            _isInitiallyDirty(false);
        };

        return result;
    };

    var startModule = sandler.appStart.module;
    var pageVM = function (contactsObservable) {
        console.log('contactsObservable');
        console.log(contactsObservable);
        var self = this;
        self.companies = startModule.getUserCompanies();

        self.contact = contactsObservable;
        self.pageTitle = ko.computed(function () {
            return (self.contact.CONTACTSID() > 0 ? "Edit Contact" : "Add Contact");
        });
        self.COMPANYID = ko.observable(contactsObservable.COMPANYID);

        self.contact.LASTNAME.extend({ required: "" });
        self.contact.FIRSTNAME.extend({ required: "" });
        
        self.yesNoData = startModule.getYesNoOptions();

        self.appointmentsource = startModule.getAppointmentSources();
        self.courses = startModule.getCourses();
        self.CourseTrainingDate = ko.observable((kendo.parseDate(self.contact.CourseTrainingDate())));
        self.LastAttemptedDate = ko.observable((kendo.parseDate(self.contact.LastAttemptedDate())));
        self.LAST_CONTACT_DATE = ko.observable((kendo.parseDate(self.contact.LAST_CONTACT_DATE())));
        self.LastEmailedDate = ko.observable((kendo.parseDate(self.contact.LastEmailedDate())));
        self.LastMeetingDate = ko.observable((kendo.parseDate(self.contact.LastMeetingDate())));
        self.LetterSentDate = ko.observable((kendo.parseDate(self.contact.LetterSentDate())));
        self.NEXT_CONTACT_DATE = ko.observable((kendo.parseDate(self.contact.NEXT_CONTACT_DATE())));
        self.Birthday = ko.observable((kendo.parseDate(self.contact.Birthday())));
        self.Anniversary = ko.observable((kendo.parseDate(self.contact.Anniversary())));

        self.dirtyFlag = new ko.dirtyFlag_contact(self);
        self.isDirty = ko.computed(function () {
            return self.dirtyFlag.isDirty()
        }, this);

        self.Save = function () {
            if (!self.contact.LASTNAME()) {
                showNoti_.error('Lastname is required', false);
                $('#contact_LastName').focus();
                return;
            }
            if (!self.contact.FIRSTNAME()) {
                showNoti_.error('Firstname is required.', false);
                $('#contact_FirstName').focus();
                return;
            }
            //console.log('ko.toJSON(self.contact)');
            //console.log(ko.toJSON(self.contact));
            $.ajax({
                url: 'api/ContactSave',
                type: "POST",
                data: ko.toJSON(self.contact),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                async: false,
                success: function (response) {
                    console.log('saved contact');
                    showNoti_.info('Contact saved successfully.', true);
                },
                error: function (response, errorText) {
                    showNoti_.error('Unable to save contact, server error occures.', true);
                    return false;
                }
            });
        };


    }

    $(document).ready(function () {

           @* Cancel (Close) Button *@
    $("#bt_cancel_evt").click(function () {
            @* Opened from Application Main Page in a Modal Window *@
            if (navi_.singlePageInModal('contact_body'))
                navi_.closeModal();
            @* Opened from other page inside Navigator Page > Close this page *@
            else if (navi_.totalPages() > 1)
                navi_.closeCurrentPage();
            @* Otherwise, redirect to Home Page *@
            else
                navi_.closeModal();

        });

    var vm = new pageVM(ko.mapping.fromJS( @Html.Raw(Json.Encode(@Model.EntityModel))));
    ko.applyBindings(vm, document.getElementById("contact_body"));

});



</script>



