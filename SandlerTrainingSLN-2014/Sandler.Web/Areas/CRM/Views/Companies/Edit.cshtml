@model dynamic
<script src="~/Scripts/Application/ng-companies.js" type="text/javascript"></script>
<script src="~/contents/knockout/knockout.mapping-latest.js" type="text/javascript"></script>


<div id="company_body" style="background-color:white">

    @*Page Header*@
    <div class="row page-header">
        <div class="col-sm-8">
            <div class="row"><div class='page-title'><span>Companies</span></div></div>
            <div class="row sub-heading"><div class='page-subtitle' data-bind="text: pageTitle"></div></div>
        </div>
        <div class="col-sm-4"></div>
    </div>
    
    <hr />


     @* Company Details *@
    <div class="container">
        <div class="row">
            @* [[[[[ Event Related ]]]]] *@
            <div class="col-md-6 no-margin">
                <div class="col-title"><span>Company Information</span></div>

                <div class="row">

                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group" >
                                
                                <label>Company&nbsp;<span class="label label-danger" data-bind='visible: COMPANYNAME.hasError, text: COMPANYNAME.validationMessage'></span></label>                  
                                <div class="controls">
                                     <input id="company_name" maxlength="50" type="text" style="width:550px;" class="form-control" data-bind="value: COMPANYNAME"/>
                                </div>
                                <label>Company Ownership</label>
                                <div class="controls">
                                    <input id="company_ownership" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: CompanyOwnership">
                                </div>
                                 <label>Company Description</label>
                                <div class="controls">
                                    <input id="company_description" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: CompanyDescription">
                                </div>
                                 <label>Address</label>
                                <div class="controls" >
                                    <input id="company_address" style="width:550px;" class="form-control" maxlength="150" type="text"  data-bind="value: Address">
                                </div>
                                 <label>City</label>
                                <div class="controls">
                                    <input id="company_city" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: City">
                                </div>
                                  <label>State</label>
                                <div class="controls">
                                    <input id="company_state" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: State">
                                </div>
                                  <label>Zip</label>
                                <div class="controls">
                                    <input id="company_zip" class="form-control" style="width:550px;" maxlength="7" type="text"  data-bind="value: Zip">
                                </div>
                                 <label>Country</label>
                                <div class="controls">
                                    <input id="company_country" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: Country">
                                </div>
                              
                                 <label>Is Same Billing Address</label>
                                 <div class="controls">
                                    <input id="company_isSameBilling" type="text" style="width:550px;" data-bind="kendoDropDownList: { dataTextField: 'Description', dataValueField: 'id', data: yesNoData, value: yesNoID }"/>
                                 </div>
                                 <label>Billing Address</label>
                                <div class="controls" >
                                    <input id="company_billingAddress" class="form-control" style="width:550px;" maxlength="150" type="text"  data-bind="value: BillingAddress">
                                </div>
                              
                                 <label>Billing City</label>
                                <div class="controls">
                                    <input id="company_billingCity" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: BillingCity">
                                </div>
                              
                                 <label>Billing State</label>
                                <div class="controls">
                                    <input id="company_billing State" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: BillingState">
                                </div>
                                 <label>Billing Zip</label>
                                <div class="controls">
                                    <input id="company_billingZip" class="form-control" style="width:550px;" maxlength="7" type="text"  data-bind="value: BillingZip">
                                </div>
                                 <label>Billing Country</label>
                                <div class="controls">
                                    <input id="company_billingCountry" class="form-control" style="width:550px;" maxlength="50" type="text"  data-bind="value: BillingCountry">
                                </div>
                              
                              
                              

                            </div>

                        </form>
                    </div>
                    
                    @*<div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                test2
                            </div>
                        </form>
                    </div>
                    *@

                </div>

                 <div class="row">
                      <form>
                          <div class="form-group">
                                 <label>Company Notes</label>
                                <div class="controls">
                                     <textarea id="company_Notes"  maxlength="100" type="text" class="form-control col-md-12" rows="5" data-bind="value: Notes"/>
                                </div>
                          </div>
                      </form>
                      </div>

                
            </div>

            <div class="col-md-6 no-margin">
                <div class="col-title"><span>Company Details</span></div>

                <div class="row">

                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                 <label>POC Last Name&nbsp;<span class="label label-danger" data-bind='visible: POCLastName.hasError, text: POCLastName.validationMessage'></span></label>                  
                                <div class="controls">
                                     <input id="company_pocLastName" maxlength="50" type="text" class="form-control" data-bind="value: POCLastName"/>
                                </div>
                                  <label>POC First Name&nbsp;<span class="label label-danger" data-bind='visible: POCLastName.hasError, text: POCLastName.validationMessage'></span></label>                  
                                <div class="controls">
                                     <input id="company_pocFirstName" maxlength="50" type="text" class="form-control" data-bind="value: POCFirstName"/>
                                </div>
                                  <label>POC Phone</label>
                                <div class="controls">
                                     <input id="company_pocPhone" maxlength="50" type="text" class="form-control" data-bind="value: POCPhone"/>
                                </div>
                                     <label>POC Department</label>
                                <div class="controls">
                                     <input id="company_pocDepartment" maxlength="50" type="text" class="form-control" data-bind="value: POCDepartment"/>
                                </div>
                                 <label>POC Email</label>
                                <div class="controls">
                                     <input id="company_pocEmail" maxlength="50" type="text" class="form-control" data-bind="value: POCEmail"/>
                                </div>
                                 <label>POC FAX</label>
                                <div class="controls">
                                     <input id="company_pocFAX" maxlength="50" type="text" class="form-control" data-bind="value: POCFax"/>
                                </div>
                                 <label>Assistant Last Name</label>
                                <div class="controls">
                                     <input id="company_assistantLastName" maxlength="50" type="text" class="form-control" data-bind="value: AssistantLastName"/>
                                </div>
                                 <label>Assistant First Name</label>
                                <div class="controls">
                                     <input id="company_assistantFirstName" maxlength="50" type="text" class="form-control" data-bind="value: AssistantFirstName"/>
                                </div>
                                 <label>Assistant Phone</label>
                                <div class="controls">
                                     <input id="company_assistant Phone" maxlength="50" type="text" class="form-control" data-bind="value: AssistantPhone"/>
                                </div>
                                
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-sm-6 no-margin">
                        <form role="form">
                            <div class="form-group">
                                  <label>Is New Company</label>
                                 <div class="controls">
                                    <input id="company_isNewCompany" type="text" data-bind="kendoDropDownList: { dataTextField: 'Description', dataValueField: 'id', data: yesNoData, value: isNewCompanyID }"/>
                                 </div>
                                 <label>Company Website</label>
                                <div class="controls">
                                     <input id="company_companyWebsite" maxlength="50" type="text" class="form-control" data-bind="value: Website"/>
                                </div>
                                  <label>Employee Quantity</label>
                                <div class="controls">
                                     <input id="company_employeeQuantity" maxlength="50" type="text" class="form-control" data-bind="value: EmpQuantity"/>
                                </div>
                                  <label>Company Value Goal</label>
                                <div class="controls">
                                     <input id="company_valueGoal" maxlength="50" type="text" class="form-control" data-bind="value: COMPANYVALUEGOAL"/>
                                </div>
                                  <label>Industry</label>
                                 <div class="controls">
                                    <input id="company_industry" type="text" data-bind="kendoDropDownList: { dataTextField: 'IndustryTypeName', dataValueField: 'IndId', data: industries, value: IndId }"/>
                                 </div>
                                  <label>Sandler Rep Last Name</label>
                                <div class="controls">
                                     <input id="company_sandlerRepLastName" maxlength="50" type="text" class="form-control" data-bind="value: RepLastName"/>
                                </div>
                                   <label>Sandler Rep First Name</label>
                                <div class="controls">
                                     <input id="company_sandlerRepFirstName" maxlength="50" type="text" class="form-control" data-bind="value: RepFirstName"/>
                                </div>
                                  <label>Discussion Topic</label>
                                <div class="controls">
                                     <input id="company_discussionTopic" maxlength="50" type="text" class="form-control" data-bind="value: DiscussionTopic"/>
                                </div>
                                   <label>Action Step</label>
                                <div class="controls">
                                     <input id="company_actionstep" maxlength="50" type="text" class="form-control" data-bind="value: ACTIONSTEP"/>
                                </div>
                                  <label>Last Contact Date</label>
                                <div class="controls">
                                     <input id="company_lastContactDate" style="max-width:150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: LASTCONTACT_DATEc"/>
                                </div>
                                  <label>Next Contact Date</label>
                                <div class="controls">
                                     <input id="company_nextContactDate" style="max-width:150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: NEXTCONTACT_DATEc"/>
                                </div>
                                
                                  <label>Creation Date</label>
                                <div class="controls">
                                     <input id="company_creationDate" style="max-width:150px;" maxlength="10" type="text" class="form-control" data-bind="kendoDatePicker: CreationDatec"/>
                                </div>
                              


                            </div>
                        </form>
                    </div>
                    
                </div>

                 



</div>


             
         </div>
       


        @* Page Footer *@
        <div class="row page-footer">
            <div class="pull-right">
                <button id="bt_cancel_evt" class="btn btn-danger btn-cancel" type="button" >Cancel</button>
                <button id="bt_save_evt" class="btn btn-primary btn-save" type="button" data-bind="enable: isDirty, click: Save">Save</button>
            </div>
        </div>

     </div>

</div>


@*Custom extender for Last Name-required *@
<script>
    ko.extenders.required = function (target, overrideMessage) {
        //add some sub-observables to our observable
        target.hasError = ko.observable();
        target.validationMessage = ko.observable();

        //define a function to do validation
        function validate(newValue) {
            target.hasError(newValue ? false : true);
            target.validationMessage(newValue ? "" : overrideMessage || "*");
        }
        //initial validation
        validate(target());
        //validate whenever the value changes
        target.subscribe(validate);
        //return the original observable
        return target;
    };
</script>



<script type="text/javascript">
    
     @* Tracking whether there is unsaved change(s). *@
    ko.dirtyFlag_company = function (root, isInitiallyDirty) {

        var result = function () { },
            _initialState = ko.observable(ko.toJSON(root)),
            _isInitiallyDirty = ko.observable(isInitiallyDirty);

        result.isDirty = ko.computed(function () {
            return _isInitiallyDirty() || _initialState() !== ko.toJSON(root);
        });

        result.reset = function () {
            _initialState(ko.toJSON(root));
            _isInitiallyDirty(false);
        };

        return result;
    };
    
   

    function companyDataVM(compData,yesNoData,industries) {
        var self = this;                 
        self.COMPANYNAME = ko.observable(compData.COMPANYNAME).extend({ required: "" });
        self.CompanyOwnership = ko.observable(compData.CompanyOwnership);
        self.CompanyDescription = ko.observable(compData.CompanyDescription);
        self.Address = ko.observable(compData.Address);
        self.City = ko.observable(compData.City);
        self.State = ko.observable(compData.State);
        self.Zip = ko.observable(compData.Zip);
        self.Country = ko.observable(compData.Country);

                
        self.yesNoData = ko.observableArray(yesNoData);
        self.yesNoID = ko.observable(compData.IsSameBillingAddress);


        self.BillingAddress = ko.observable(compData.BillingAddress);
        self.BillingCity = ko.observable(compData.BillingCity);
        self.BillingState = ko.observable(compData.BillingState);
        self.BillingZip = ko.observable(compData.BillingZip);
        self.BillingCountry = ko.observable(compData.BillingCountry);

        self.POCLastName = ko.observable(compData.POCLastName).extend({ required: "" });
        self.POCFirstName = ko.observable(compData.POCFirstName).extend({ required: "" });
        self.POCPhone = ko.observable(compData.POCPhone);
        self.POCDepartment = ko.observable(compData.POCDepartment);
        self.POCEmail = ko.observable(compData.POCEmail);
        self.POCFax = ko.observable(compData.POCFax);

        self.AssistantLastName = ko.observable(compData.AssistantLastName);
        self.AssistantFirstName = ko.observable(compData.AssistantFirstName);
        self.AssistantPhone = ko.observable(compData.AssistantPhone);

        self.yesNoData = ko.observableArray(yesNoData);
        self.isNewCompanyID = ko.observable(compData.IsNewCompany);

        self.Website = ko.observable(compData.Website);
        self.EmpQuantity = ko.observable(compData.EmpQuantity);
        self.COMPANYVALUEGOAL = ko.observable(compData.COMPANYVALUEGOAL);
        
        self.industries = ko.observableArray(industries);
        self.IndId = ko.observable(compData.IndustryId);
        
        self.RepLastName = ko.observable(compData.RepLastName);
        self.RepFirstName = ko.observable(compData.RepFirstName);
        self.DiscussionTopic = ko.observable(compData.DiscussionTopic);
        self.ACTIONSTEP = ko.observable(compData.ACTIONSTEP);
        self.RepFirstName = ko.observable(compData.RepFirstName);
        
        if (compData.LASTCONTACT_DATE != null && compData.LASTCONTACT_DATE != "") {
            self.LASTCONTACT_DATEc = ko.observable(kendo.parseDate(compData.LASTCONTACT_DATE));
        }
        else {
            self.LASTCONTACT_DATEc = ko.observable();
        }
        self.LASTCONTACT_DATE = ko.computed(function () {
            return dateUtil_.toNoTimeZone(self.LASTCONTACT_DATEc());
        });

        if (compData.NEXTCONTACT_DATE != null && compData.NEXTCONTACT_DATE != "") {
            self.NEXTCONTACT_DATEc = ko.observable(kendo.parseDate(compData.NEXTCONTACT_DATE));
        }
        else {
            self.NEXTCONTACT_DATEc = ko.observable();
        }
        self.NEXTCONTACT_DATE = ko.computed(function () {
            return dateUtil_.toNoTimeZone(self.NEXTCONTACT_DATEc());
        });

        if (compData.CreationDate != null && compData.CreationDate != "") {
            self.CreationDatec = ko.observable(kendo.parseDate(compData.CreationDate));
        }
        else {
            self.CreationDatec = ko.observable();
        }
        self.CreationDate = ko.computed(function () {
            return dateUtil_.toNoTimeZone(self.CreationDatec());
        });
        
        //self.LASTCONTACT_DATE = ko.observable((kendo.parseDate(compData.LASTCONTACT_DATE)));
        //self.NEXTCONTACT_DATE = ko.observable((kendo.parseDate(compData.NEXTCONTACT_DATE)));
        // self.CreationDate = ko.observable((kendo.parseDate(compData.CreationDate)));
    
        self.Notes = ko.observable(compData.Notes);

        self.pageTitle = ko.computed(function () {
            return (@Model.companyId > 0 ? "Edit Company" : "Add Company");
        });
       
        self.dirtyFlag = new ko.dirtyFlag_company(self);

        self.isDirty = ko.computed(function () {
            return self.dirtyFlag.isDirty()
        }, this);

        self.Save = function () {
            @* Validation *@
            if (!self.COMPANYNAME()) {
                showNoti_.error('Company Name is Required!!', false);
                $('#company_name').focus();
                return;
            }
            //Continue with Save after Client side Validation is Ok
        };

        
    }
    $(document).ready(function () {

           @* Cancel (Close) Button *@
        $("#bt_cancel_evt").click(function () {
            @* Opened from Application Main Page in a Modal Window *@
            if (navi_.singlePageInModal('company_body'))
                navi_.closeModal();
            @* Opened from other page inside Navigator Page > Close this page *@
        else if (navi_.totalPages() > 1)
            navi_.closeCurrentPage();
            @* Otherwise, redirect to Home Page *@
            else
                navi_.closeModal();
            
        });


        var startModule = sandler.appStart.module;
        compData = jsonDataCaller.syncCall("/api/Company/Get?id=@Model.companyId", null);
        yesNoData = startModule.getYesNoOptions();
        industries = startModule.getIndustryTypes();
        
        var companyVM = new companyDataVM(compData,yesNoData,industries);               
        ko.applyBindings(companyVM, document.getElementById("company_body"));

    });
    
</script>



